<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ticket Booking</title>
    <link rel = "stylesheet" href = "../startPageStyle.css">
    <link rel = "icon" href = "https://library.kissclipart.com/20180830/abq/kissclipart-train-clipart-train-rail-transport-rapid-transit-c4c301d377f15d73.png">
    <script src="../scripts/jquery.min.js"></script>
    <script type = "text/javascript">
        var rootId, dateFrom, dateTo, from, to, seat, carriage, dist, ticketPrice, totalPrice, trainId;


        function validate(doctype, tariff, docId, PFname, PLname, phoneNum, citizenship, gender, dateOfBirth){

            if (doctype == "") {
                alert("Please, choose your document type.");
            } else if (tariff == "") {
                alert("Please, choose tariff.");
            } else if (docId == "") {
                alert("Please, fill out your document ID.");
            } else if (PFname == "") {
                alert("Please, fill out your first name.");
            } else if (PLname == "") {
                alert("Please, fill out your last name.");
            } else if (phoneNum == "") {
                alert("Please, fill out your phone number.");
            }else if (citizenship== "") {
                alert("Please, choose your country.");
            }else if (gender == "") {
                alert("Please, fill out your gender.");
            }else if (dateOfBirth == "") {
                alert("Please, fill out your date of birth.");
            }

        }
        function createPassenger(){
            var doctype = document.getElementById('doctype').value;
            var tariff = document.getElementById('tariff').value;
            var docId = document.getElementById('docID').value;
            var PFname = document.getElementById('fname').value;
            var PLname = document.getElementById('lname').value;
            var phoneNum = document.getElementById('telephone').value;
            var citizenship = document.getElementById('country').value;
            var gender = document.getElementsByName('gender').value;
            var dateOfBirth = document.getElementById('dob').value;

            validate(doctype, tariff, docId, PFname, PLname, phoneNum, citizenship, gender, dateOfBirth);
            var passenger = [doctype, tariff, docId, PFname, PLname, phoneNum, citizenship, gender, dateOfBirth];
            console.log(passenger);

        }

        function createTicket(){
            var ticket = [dateFrom, dateTo, ticketPrice, routeId, trainId,  seat, carriage, from, to];
            console.log(ticket);
        }

        function createOrder(){
            var numOfpassengers = document.getElementById('numOfpassengers').value;
            var payment = document.getElementById('payment').value;
            var today = new Date();
            var bookingDate = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
            var bookingTime = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            totalPrice = ticketPrice; /////!!!!!!! change when more than one passenger!!!!!!
            var order = [numOfpassengers, bookingDate, bookingTime, payment,  totalPrice];
            console.log(order);
        }

        function showRoutes(items) {
            items.forEach(function (e) {

                if ($("#stationFrom").val() == e[7] && ($("#stationTo").val() == e[8]) && ($("#dateFrom").val() == e[1])){
                    $("#routes-table").append("<tr align=\"center\"><td>" + e[0] + "</td><td>" + e[1] + "</td><td>" + e[2] + "</td><td>" + e[3] + "</td><td>" + e[4] + "</td><td>" + e[5] + "</td><td>" + e[6] + "</td><td>" + e[7] + "</td><td>" + e[8] + "</td><td><button class = \"selected-r\" id =\""+ e[0]+"\">Select</button></td></tr>");
                }
            }) ;
            if ($('#routes-table tr').length == 1) {
                alert("No routes found!")
            }
            $("#routes-table tr > td > button").on('click', function () {
                from = $(this).closest('tr').find("td").eq(7).html();
                to = $(this).closest('tr').find("td").eq(8).html();
                rootId = $(this).closest('tr').find("td").eq(0).html();
                dateFrom = $(this).closest('tr').find("td").eq(1).html();
                dateTo = $(this).closest('tr').find("td").eq(2).html();
                dist = $(this).closest('tr').find("td").eq(5).html();
                console.log(from, to, rootId, dateFrom, dateTo)
                postSeats();
                getSeats();
            });

        }
        function showSeats(items) {
            items.forEach(function (e) {
                var price = parseFloat(e[4]) + parseFloat(dist) * 200;
                $("#seats-table").append("<tr align=\"center\"><td>" + e[0] + "</td><td>" + e[1] + "</td><td>" + e[2] + "</td><td>" + e[3] + "</td><td>" + price + "</td><td><button class = \"selected-s\" id =\""+ e[0]+"\">Select</button></td></tr>");
                trainId = e[5];
            });

            // var millisecondsToWait = 500;
            // setTimeout(function() {
            //     if ($('#seats-table tr').length == 1) {
            //         alert("No seats found!")
            //     }
            // }, millisecondsToWait);



            $("#seats-table tr > td > button").on('click', function () {
                seat = $(this).closest('tr').find("td").eq(0).html();
                carriage = $(this).closest('tr').find("td").eq(2).html();
                ticketPrice = $(this).closest('tr').find("td").eq(4).html();
                console.log(seat, trainId, carriage, ticketPrice);
                $( "div.seat" ).text( "Your seat is " + seat + ", in carriage " + carriage + ", price: " + ticketPrice );
            });

        }

        function getRoutes() {
            $.ajax({
                url : '../services/routes',
                dataType : 'json',
                success : function(r) {
                    showRoutes(r);
                }
            });
        }

        function getSeats() {
            $.ajax({
                url : '../services/seats',
                dataType : 'json',
                success : function(r) {
                    showSeats(r);
                }
            });
        }

        function postSeats(){
            $.post("../services/seats", {RouteID: rootId}, function(r) {
                console.log(r);

            }).fail(function(r) {
                alert(r);
                console.log(r.responseText);
            });
        }


        $(document).on("click", ".find-routes", function() {
            getRoutes();
        });

        $(document).on("click", ".add-pass-btn", function() {
            var passForm = $(".newPass").eq(0).clone().show();
            $(".addPass").append(passForm);
        });

        $(document).on("click", ".remove-pass-btn", function() {
            var index = $(".remove-pass-btn").index(this);
            console.log(index);
            if ($(".newPass").length>1) {$(".newPass").eq(index).remove()}
        });

        $(document).on("click", ".book", function() {
            createOrder();
            createTicket();
            createPassenger();
            window.location.href='payment.html';
        });

    </script>
</head>

<body>

<h2>Ticket Booking</h2>

<h2>Routes</h2>
<table id="routes-table">
    <tr>
        <th>RouteID</th>
        <th>DateFrom</th>
        <th>DateTo</th>
        <th>TimeFrom</th>
        <th>TimeTo</th>
        <th>Distance (in km)</th>
        <th>Status</th>
        <th>StationFrom</th>
        <th>StationTo</th>
        <th></th>
    </tr>
</table>

<select id="stationFrom">
    <option value="AST">Astana</option>
    <option value="ALM">Almaty</option>
    <option value="SEM">Semey</option>
    <option value="ATB">Aktobe</option>
    <option value="PET">Petropavlovsk</option>
    <option value="KSH">Kokshetau</option>
</select>

<select id="stationTo">
    <option value="AST">Astana</option>
    <option value="ALM">Almaty</option>
    <option value="SEM">Semey</option>
    <option value="ATB">Aktobe</option>
    <option value="PET">Petropavlovsk</option>
    <option value="KSH">Kokshetau</option>
</select>
<br>
<label for="dateFrom">Departure Date</label>
<input type="date" id="dateFrom" required>
<br>
<button class="find-routes"> Find Routes</button>
<br><br><br>
<table id="seats-table">
    <tr>
        <th>SeatNumber</th>
        <th>Status</th>
        <th>Carriage Number</th>
        <th>Class</th>
        <th>Price</th>
    </tr>
</table>
<div class="seat"></div>
<label> Number of passengers </label>>
<input type="number" id = "numOfpassengers" required>
<div class="addPass">
    <div class="newPass">

        <label for="fname">First Name</label>
        <input type="text" id="fname" required>
        <br>
        <label for="lname">Last Name</label>
        <input type="text" id="lname" required>
        <br>
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob" required>
        <br>
        <form>
            <label>Gender</label>
            <input type="radio" name="gender" value="M" id = "male" checked>
            <label for="male">Male</label>
            <span class="check"></span>
            <input type="radio" name="gender" value="F" id = "female">
            <label for="female">Female</label>
            <span class="check"></span>
        </form>
        <br>
        <label>Citizenship</label>
        <select id="country">
            <option value="Kazakhstan">Kazakhstan</option>
            <option value="Russia">Russia</option>
            <option value="Other">Other</option>
        </select>
        <br>
        <label>Document Type</label>
        <select id="doctype">
            <option value="passport">Passport</option>
            <option value="IDcard">ID Card</option>
        </select>
        <br>
        <label>Tariff</label>
        <select id="tariff">
            <option value="regular">Regular</option>
            <option value="retired">Retired</option>
            <option value="student">Student</option>
            <option value="child">Child</option>
        </select>
        <br>
        <label>Payment Type</label>
        <select id="payment">
            <option value="BankCard">Bank card</option>
            <option value="OnlineWallet">Online wallet</option>
            <option value="Other">Other</option>
        </select>
        <br>
        <label for="docID">Document ID</label>
        <input type="text" id="docID" required>
        <br>
        <label for="telephone">Phone Number</label>
        <input type="text" id="telephone" required>
        <br>
        <button class="remove-pass-btn">Remove a Passenger</button>
    </div>
</div>
<button class="add-pass-btn">Add a Passenger</button>
<button class="book" type="button">Book a ticket</button>



</body>
</html>
